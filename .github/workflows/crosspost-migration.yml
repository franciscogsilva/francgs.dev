name: Crosspost Migration Queue

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:

concurrency:
  group: crosspost-migration-queue
  cancel-in-progress: false

jobs:
  crosspost-one:
    runs-on: ubuntu-latest
    continue-on-error: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10

      - name: Install dependencies
        run: pnpm install

      - name: Select platform for this slot
        id: slot
        run: |
          minute=$(date -u +%M)
          if [ $((10#$minute % 10)) -eq 0 ]; then
            echo "platform=devto" >> $GITHUB_OUTPUT
          else
            echo "platform=medium" >> $GITHUB_OUTPUT
          fi

      - name: Restore crosspost state cache
        uses: actions/cache@v4
        with:
          path: .crosspost/state-${{ steps.slot.outputs.platform }}.json
          key: crosspost-state-${{ steps.slot.outputs.platform }}-${{ github.run_id }}
          restore-keys: |
            crosspost-state-${{ steps.slot.outputs.platform }}-

      - name: Publish one queued article
        continue-on-error: true
        env:
          DEVTO_API_KEY: ${{ secrets.DEVTO_API_KEY }}
          MEDIUM_TOKEN: ${{ secrets.MEDIUM_TOKEN }}
          SITE_URL: https://francgs.dev
          CROSSPOST_STATE_PATH: .crosspost/state-${{ steps.slot.outputs.platform }}.json
          CROSSPOST_LANGS: en
          CROSSPOST_DEVTO_PUBLISHED: "true"
          CROSSPOST_DEVTO_MAX_RETRIES: "6"
          CROSSPOST_DEVTO_MIN_INTERVAL_MS: "5000"
          CROSSPOST_MAX_POSTS: "1"
          CROSSPOST_MEDIUM_STATUS: "public"
          CROSSPOST_FAIL_ON_ERROR: "false"
        run: pnpm run crosspost -- --all --platform=${{ steps.slot.outputs.platform }}
