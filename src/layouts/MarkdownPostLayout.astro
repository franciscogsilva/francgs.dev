---
import CopyCodeButton from "../components/CopyCodeButton.astro";
import PostNavigation from "../components/PostNavigation.astro";
import TableOfContents from "../components/TableOfContents.astro";
import { calculateReadingTime } from "../helpers/readingTime";
import { getTableOfContents } from "../helpers/tableOfContents";
import BaseLayout from "./BaseLayout.astro";

const { frontmatter } = Astro.props;
const { headings } = Astro.props;

// Calculate reading time from the raw content
const rawContent = await Astro.slots.render("default");
const readingTime = calculateReadingTime(rawContent);

// Get table of contents from headings
const toc = headings ? getTableOfContents(headings) : [];

// TODO: Get prev/next posts (will need to be passed from the page or calculated)
// For now, we'll leave these undefined
const prevPost = undefined;
const nextPost = undefined;
---

<BaseLayout
  title={frontmatter.title}
  description={frontmatter.description}
  image={frontmatter.image?.url}
  articleDate={frontmatter.pubDate.toString()}
>
  <article class="blog-post">
    <header
      class="py-4 flex flex-col items-start space-y-4 border-b border-double border-gray-400 dark:border-gray-700"
    >
      <h1
        class="text-3xl font-extrabold leading-normal tracking-normal text-gray-900 dark:text-gray-100 sm:text-4xl md:text-5xl"
      >
        {frontmatter.title}
      </h1>
      <div
        class="w-full flex flex-wrap gap-4 items-center place-content-between"
      >
        <div class="-mx-2">
          {
            frontmatter.tags.map((tag: string) => (
              <>
                <a href={`/tags/${tag}`}>
                  <span class="inline-block py-1 px-2 mx-2 rounded border border-gray-700 hover:border-accent text-xs font-medium transition-colors duration-200">
                    {tag}
                  </span>
                </a>
              </>
            ))
          }
        </div>
        <dl>
          <div
            class="flex flex-row items-center gap-2 text-sm font-semibold text-gray-700 dark:text-gray-300"
          >
            <dt class="sr-only">Published on</dt>
            <dd class="">
              <time datetime={frontmatter.pubDate}>
                {frontmatter.pubDate.toString().slice(0, 10)}
              </time>
            </dd>
            â€¢
            <span>{readingTime}</span>
          </div>
        </dl>
      </div>
    </header>
  </article>
  <!-- Content wrapper with semi-transparent background -->
  <div class="relative">
    <!-- Semi-transparent dark background overlay -->
    <div
      class="absolute inset-0 rounded-lg"
      style="background-color: color-mix(in oklab, black 10%, transparent);"
    >
    </div>

    <!-- Content -->
    <section
      class="relative pb-8 divide-y divide-gray-200 xl:divide-y-0 dark:divide-gray-700"
    >
      {
        frontmatter.image && frontmatter.image.url && (
          <div class="relative flex flex-col items-center">
            <img
              class="object-cover md:w-3/4 rounded-lg shadow-lg overflow-hidden my-4 mx-auto"
              alt={frontmatter.image.alt}
              src={frontmatter.image.url}
            />
          </div>
        )
      }
      <div class="flex flex-col">
        <!-- Grid with content centered, ToC narrow on right -->
        <div class="xl:grid xl:grid-cols-6 xl:gap-x-10">
          <!-- Main Content (takes 4 columns for better centering) -->
          <div
            class:list={[
              "pt-10 pb-8 prose dark:prose-dark",
              toc.length > 0 ? "xl:col-span-4" : "xl:col-span-6",
            ]}
            style="max-width: 65ch;"
          >
            <slot />
          </div>

          <!-- Table of Contents Sidebar on RIGHT (narrower, hidden on mobile) -->
          {
            toc.length > 0 && (
              <aside class="hidden xl:block xl:col-span-2 pt-10">
                <TableOfContents headings={toc} />
              </aside>
            )
          }
        </div>

        <!-- Post Navigation -->
        <div class="xl:col-span-6" style="max-width: 65ch;">
          <PostNavigation prev={prevPost} next={nextPost} />
        </div>
      </div>
    </section>
  </div>

  <!-- Copy code button functionality -->
  <CopyCodeButton />
</BaseLayout>
