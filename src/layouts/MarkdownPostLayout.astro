---
import type { MarkdownInstance } from "astro";
import Comments from "../components/Comments.astro";
import CopyCodeButton from "../components/CopyCodeButton.astro";
import PostNavigation from "../components/PostNavigation.astro";
import ShareButtons from "../components/ShareButtons.astro";
import TableOfContents from "../components/TableOfContents.astro";
import { calculateReadingTime } from "../helpers/readingTime";
import { getTableOfContents } from "../helpers/tableOfContents";
import BaseLayout from "./BaseLayout.astro";

const { frontmatter } = Astro.props;
const { headings } = Astro.props;

// Calculate reading time from the raw content
const rawContent = await Astro.slots.render("default");
const readingTime = calculateReadingTime(rawContent);

// Get table of contents from headings
const toc = headings ? getTableOfContents(headings) : [];

// Get prev/next posts
const allPosts = Object.values(
  import.meta.glob<MarkdownInstance<any>>("../pages/blog/*.md", {
    eager: true,
  }),
).sort(
  (a, b) =>
    new Date(b.frontmatter.pubDate).getTime() -
    new Date(a.frontmatter.pubDate).getTime(),
);

const currentIndex = allPosts.findIndex(
  (post) => post.url === Astro.url.pathname,
);
const prevPost = currentIndex > 0 ? allPosts[currentIndex - 1] : undefined;
const nextPost =
  currentIndex < allPosts.length - 1 ? allPosts[currentIndex + 1] : undefined;
---

<BaseLayout
  title={frontmatter.title}
  description={frontmatter.description}
  image={frontmatter.image?.url}
  articleDate={frontmatter.pubDate.toString()}
>
  <article class="blog-post">
    <header
      class="py-4 flex flex-col items-start space-y-4 border-b border-double border-gray-400 dark:border-gray-700"
    >
      <h1
        class="text-3xl font-extrabold leading-normal tracking-normal text-gray-900 dark:text-gray-100 sm:text-4xl md:text-5xl"
      >
        {frontmatter.title}
      </h1>
      <div
        class="w-full flex flex-wrap gap-4 items-center place-content-between"
      >
        <div class="-mx-2">
          {
            frontmatter.tags.map((tag: string) => (
              <>
                <a href={`/tags/${tag}`}>
                  <span class="inline-block py-1 px-2 mx-2 rounded border border-gray-700 hover:border-accent text-xs font-medium transition-colors duration-200">
                    {tag}
                  </span>
                </a>
              </>
            ))
          }
        </div>
        <dl>
          <div
            class="flex flex-row items-center gap-2 text-sm font-semibold text-gray-700 dark:text-gray-300"
          >
            <dt class="sr-only">Published on</dt>
            <dd class="">
              <time datetime={frontmatter.pubDate}>
                {frontmatter.pubDate.toString().slice(0, 10)}
              </time>
            </dd>
            •
            <span>{readingTime}</span>
          </div>
        </dl>
      </div>
    </header>
  </article>
  <!-- Content wrapper with semi-transparent background -->
  <div class="relative">
    <!-- Semi-transparent dark background overlay -->
    <div
      class="absolute inset-0 rounded-lg"
      style="background-color: color-mix(in oklab, black 10%, transparent);"
    >
    </div>

    <!-- Content -->
    <section
      class="relative pb-8 divide-y divide-gray-200 xl:divide-y-0 dark:divide-gray-700"
    >
      {
        frontmatter.image && frontmatter.image.url && (
          <div class="relative flex flex-col items-center">
            <img
              class="object-cover md:w-3/4 rounded-lg shadow-lg overflow-hidden my-4 mx-auto"
              alt={frontmatter.image.alt}
              src={frontmatter.image.url}
            />
          </div>
        )
      }
      <div class="flex flex-col">
        <!-- Grid with content centered, ToC narrow on right -->
        <div class="xl:grid xl:grid-cols-6 xl:gap-x-10">
          <!-- Main Content (takes 4 columns for better centering) -->
          <div
            class:list={[
              "pt-10 pb-8 prose dark:prose-dark",
              toc.length > 0 ? "xl:col-span-4" : "xl:col-span-6",
            ]}
            style="max-width: 65ch;"
          >
            <slot />
          </div>

          <!-- Table of Contents Sidebar on RIGHT (narrower, hidden on mobile) -->
          {
            toc.length > 0 && (
              <aside class="hidden xl:block xl:col-span-2 pt-10">
                <TableOfContents
                  headings={toc}
                  articleId={Astro.url.pathname}
                />
              </aside>
            )
          }
        </div>
      </div>

      <!-- Full Width Sections Below Content -->
      <div class="full-width-section">
        <!-- Happy Reading -->
        <div class="happy-reading">
          <p>Happy reading! ☕</p>
        </div>

        <!-- Share Buttons -->
        <ShareButtons title={frontmatter.title} url={Astro.url.toString()} />

        <!-- Post Navigation -->
        <PostNavigation prev={prevPost} next={nextPost} />

        <!-- Comments -->
        <Comments />
      </div>
    </section>
  </div>

  <!-- Copy code button functionality -->
  <CopyCodeButton />
</BaseLayout>

<style>
  .full-width-section {
    width: 100%;
    max-width: 100%;
    margin-top: 2rem;
  }

  .happy-reading {
    text-align: center;
    padding: 1.5rem 0 0.5rem;
    margin: 0 auto 0;
    max-width: 65ch;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
  }

  .happy-reading p {
    font-size: 1.25rem;
    font-weight: 500;
    color: rgba(255, 255, 255, 0.8);
    margin: 0;
  }
</style>
