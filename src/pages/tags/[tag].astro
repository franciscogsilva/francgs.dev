---
import type { MarkdownInstance } from "astro";
import PostCard from "../../components/PostCard.astro";
import BaseLayout from "../../layouts/BaseLayout.astro";

const allPosts = Object.values(
  import.meta.glob<MarkdownInstance<any>>("../blog/*.md", { eager: true }),
);

const tags: Array<string> = [
  ...new Set(allPosts.map((post: any) => post.frontmatter.tags).flat()),
];

export const prerender = true;

export async function getStaticPaths() {
  const allPosts = Object.values(
    import.meta.glob<MarkdownInstance<any>>("../blog/*.md", { eager: true }),
  );

  const tags: Array<string> = [
    ...new Set(allPosts.map((post: any) => post.frontmatter.tags).flat()),
  ];

  console.log(tags);

  return tags.map((tag: string) => {
    const filteredPosts: MarkdownInstance<Record<string, any>>[] =
      allPosts.filter((post: any) => post.frontmatter.tags.includes(tag));
    return {
      params: { tag },
      props: { posts: filteredPosts },
    };
  });
}

const { tag } = Astro.params;
const { posts } = Astro.props as Record<string, any>;

const description = "";
---

<BaseLayout title=`Tag - ${tag}` description={description}>
  <div class="pb-6 pt-6">
    <h1
      class="text-3xl font-extrabold leading-9 tracking-tight text-gray-900 dark:text-gray-100 sm:hidden sm:text-4xl sm:leading-10 md:text-6xl md:leading-14"
    >
      {tag}
    </h1>
    <div class="flex sm:space-x-24">
      <div
        class="hidden h-full max-h-screen min-w-[280px] max-w-[280px] flex-wrap overflow-auto pt-5 sm:flex"
      >
        <div class="px-6 py-4 w-full">
          <h3
            class="font-bold text-gray-900 dark:text-gray-100 uppercase tracking-wider text-sm mb-4"
          >
            All Tags
          </h3>
          <div class="flex flex-col space-y-1">
            <a
              class="group flex items-center justify-between px-3 py-2 text-sm font-medium rounded-md transition-colors duration-200
                     text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-800 hover:text-gray-900 dark:hover:text-gray-100"
              href="/blog"
            >
              <span>All Posts</span>
            </a>

            {
              tags.map((currentTag: string) => {
                const isActive = tag === currentTag;
                const count = allPosts.filter((post) =>
                  post.frontmatter.tags?.includes(currentTag),
                ).length;

                return (
                  <a
                    href={`/tags/${currentTag}`}
                    class={`group flex items-center justify-between px-3 py-2 text-sm font-medium rounded-md transition-all duration-200
                      ${
                        isActive
                          ? "bg-primary/10 text-primary border-l-2 border-primary"
                          : "text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-800 hover:text-gray-900 dark:hover:text-gray-100 border-l-2 border-transparent"
                      }`}
                  >
                    <span class="capitalize">{currentTag}</span>
                    <span
                      class={`text-xs px-2 py-0.5 rounded-full 
                        ${
                          isActive
                            ? "bg-primary/20 text-primary"
                            : "bg-gray-100 dark:bg-gray-800 text-gray-500 group-hover:bg-gray-200 dark:group-hover:bg-gray-700"
                        }`}
                    >
                      {count}
                    </span>
                  </a>
                );
              })
            }
          </div>
        </div>
      </div>

      <div class="flex sm:space-x-24">
        <div>
          <div class="grid grid-cols-1 gap-6">
            {
              posts.map((post: any) => (
                <PostCard
                  pubDate={post.frontmatter.pubDate}
                  url={post.url}
                  title={post.frontmatter.title}
                  tags={post.frontmatter.tags}
                  description={post.frontmatter.description}
                />
              ))
            }
          </div>
        </div>
      </div>
    </div>
  </div>
</BaseLayout>
