---
import PageHeader from "../components/PageHeader.astro";
import BaseLayout from "../layouts/BaseLayout.astro";

const title = "Contact Me";
const description = "Get in touch with Francisco Gonz√°lez";
---

<BaseLayout title={title} description={description}>
  <PageHeader title={title} />

  <div class="contact-container">
    <p class="contact-intro">
      Have a question or want to work together? Feel free to reach out!
    </p>

    <form class="contact-form" id="contactForm">
      <input
        type="hidden"
        name="subject"
        value="New Contact Form Submission from francgs.dev"
      />
      <!-- Honeypot for spam protection -->
      <input
        type="checkbox"
        name="botcheck"
        class="hidden"
        style="display: none;"
      />

      <div class="form-group">
        <label for="name">Name</label>
        <input
          type="text"
          id="name"
          name="name"
          required
          placeholder="Your name"
        />
      </div>

      <div class="form-group">
        <label for="email">Email</label>
        <input
          type="email"
          id="email"
          name="email"
          required
          placeholder="your.email@example.com"
        />
      </div>

      <div class="form-group">
        <label for="message">Message</label>
        <textarea
          id="message"
          name="message"
          required
          rows="6"
          placeholder="Your message..."></textarea>
      </div>

      <button type="submit" class="submit-btn">
        <span class="btn-text">Send Message</span>
        <span class="btn-loader" style="display: none;">Sending...</span>
      </button>
    </form>

    <div class="success-message" id="successMessage" style="display: none;">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M5 13l4 4L19 7"></path>
      </svg>
      <p>Thanks for reaching out! I'll get back to you soon.</p>
    </div>
  </div>
</BaseLayout>

<style>
  /* ... existing styles ... */
  .contact-container {
    max-width: 42rem;
    margin: 2rem auto;
  }

  .contact-intro {
    font-size: 1.125rem;
    color: rgba(255, 255, 255, 0.8);
    margin-bottom: 2rem;
    line-height: 1.6;
  }

  .contact-form {
    background: rgba(255, 255, 255, 0.02);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 1rem;
    padding: 2rem;
  }

  .form-group {
    margin-bottom: 1.5rem;
  }

  .form-group label {
    display: block;
    font-size: 0.875rem;
    font-weight: 600;
    color: rgba(255, 255, 255, 0.9);
    margin-bottom: 0.5rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .form-group input,
  .form-group textarea {
    width: 100%;
    padding: 0.75rem 1rem;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 0.5rem;
    color: rgba(255, 255, 255, 0.9);
    font-size: 1rem;
    transition: all 0.2s ease;
  }

  .form-group input:focus,
  .form-group textarea:focus {
    outline: none;
    border-color: rgba(59, 130, 246, 0.5);
    background: rgba(255, 255, 255, 0.08);
  }

  .form-group textarea {
    resize: vertical;
    min-height: 120px;
  }

  .submit-btn {
    width: 100%;
    padding: 1rem;
    background: rgba(59, 130, 246, 0.2);
    border: 1px solid rgba(59, 130, 246, 0.3);
    border-radius: 0.5rem;
    color: rgba(255, 255, 255, 0.9);
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .submit-btn:hover {
    background: rgba(59, 130, 246, 0.3);
    border-color: rgba(59, 130, 246, 0.5);
    transform: translateY(-2px);
  }

  .submit-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .success-message {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1.5rem;
    background: rgba(34, 197, 94, 0.1);
    border: 1px solid rgba(34, 197, 94, 0.3);
    border-radius: 0.75rem;
    color: rgba(34, 197, 94, 1);
    margin-top: 1.5rem;
  }

  .success-message svg {
    width: 2rem;
    height: 2rem;
    flex-shrink: 0;
  }

  .success-message p {
    margin: 0;
    font-weight: 500;
  }
</style>

<script>
  const form = document.getElementById("contactForm") as HTMLFormElement;
  const successMessage = document.getElementById("successMessage");

  if (form) {
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const submitBtn = form.querySelector(".submit-btn") as HTMLButtonElement;
      const btnText = submitBtn.querySelector(".btn-text") as HTMLElement;
      const btnLoader = submitBtn.querySelector(".btn-loader") as HTMLElement;

      submitBtn.disabled = true;
      btnText.style.display = "none";
      btnLoader.style.display = "inline";

      const formData = new FormData(form);
      const rawPayload = Object.fromEntries(formData);

      try {
        // Step 1: Server-side validation + get access key
        const validateRes = await fetch("/api/contact", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(rawPayload),
        });

        const validateData = await validateRes.json();

        if (!validateRes.ok || !validateData.validated) {
          alert(validateData.error || "Validation failed. Please try again.");
          return;
        }

        // Step 2: Submit to Web3Forms from browser (required by their Cloudflare setup)
        const web3Res = await fetch("https://api.web3forms.com/submit", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Accept: "application/json",
          },
          body: JSON.stringify(validateData.payload),
        });

        const web3Data = await web3Res.json();

        if (web3Res.ok && web3Data.success) {
          form.reset();
          if (successMessage) {
            successMessage.style.display = "flex";
          }
          setTimeout(() => {
            if (successMessage) {
              successMessage.style.display = "none";
            }
          }, 5000);
        } else {
          alert(web3Data.message || "Something went wrong. Please try again.");
        }
      } catch {
        alert("Something went wrong. Please try again.");
      } finally {
        submitBtn.disabled = false;
        btnText.style.display = "inline";
        btnLoader.style.display = "none";
      }
    });
  }
</script>
